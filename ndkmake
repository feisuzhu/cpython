#!/bin/bash -x

. ndkenv

PYTHON_VERSION="2.7.9"

BASEDIR=`pwd`
output_dir=$BASEDIR/ndkbuild
rm -rf $output_dir/arm

if [ ! -f $output_dir/host/bin/python ]; then
    mkdir -p $output_dir/host
    # create Python Host version 
    ./configure --prefix=$output_dir/host
    make -j8
    make -j8 Parser/pgen
    mv Parser/pgen $output_dir/host
    make install
    make clean
fi

mkdir -p $output_dir/arm

# ???? what it does?
## fix setup.py
#mv setup.py setup.py.orig
#cat setup.py.orig | awk '{ if (NR==316) {print "    " $0} else {print $0}}' > setup.py

MY_HOSTPYTHON=$output_dir/host/bin/python
MY_HOSTPGEN=$output_dir/host/pgen

if [ x$1 != xnoconf ]; then
    if ! ./configure CONFIG_SITE=config.site.ndk LDFLAGS="-Wl,--allow-shlib-undefined" CFLAGS="-mandroid -fomit-frame-pointer --sysroot $ANDROID_NDK/platforms/$ANDROID_NATIVE_API_LEVEL/arch-arm" HOSTPYTHON=$MY_HOSTPYTHON HOSTPGEN=$MY_HOSTPGEN --host=arm-linux-androideabi --build=x86_64-unknown-linux-gnu --enable-shared --prefix="$output_dir/arm" --disable-ipv6; then
        exit 1;
    fi

    cd $BASEDIR/Modules/gevent110ext/c-ares
    rm ares_build.h
    rm ares_config.h
    CONFIG_COMMANDS= CONFIG_FILES= ./configure CFLAGS="-mandroid -fomit-frame-pointer --sysroot $ANDROID_NDK/platforms/$ANDROID_NATIVE_API_LEVEL/arch-arm" --host=arm-linux-androideabi --build=x86_64-unknown-linux-gnu

    cd $BASEDIR/Modules/gevent110ext/libev
    rm config.h
    ./configure CFLAGS="-mandroid -fomit-frame-pointer --sysroot $ANDROID_NDK/platforms/$ANDROID_NATIVE_API_LEVEL/arch-arm" --host=arm-linux-androideabi --build=x86_64-unknown-linux-gnu

    cd $BASEDIR
fi
sed -i "s|^INSTSONAME=\(.*.so\).*|INSTSONAME=\\1|g" Makefile
make -j8 install HOSTPYTHON=$MY_HOSTPYTHON HOSTPGEN=$MY_HOSTPGEN CROSS_COMPILE=arm-linux-androideabi- CROSS_COMPILE_TARGET=yes
